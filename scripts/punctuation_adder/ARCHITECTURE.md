# Punctuation Adder 架构文档

## 概述

Punctuation Adder 使用机器学习模型为英文文本自动添加标点符号，支持句子分割和首字母大写，支持单文件和通配符批量处理。

## 技术架构

### 核心组件

#### 1. 模型选择: `deepmultilingualpunctuation`

**选择理由:**
- **轻量级**: RNN-based 模型，资源需求低
- **多语言支持**: 支持英文、德文、法文等多种语言（不支持中文）
- **易用性**: API简单，代码量少
- **性能**: 处理速度快，适合批量操作

**备选方案:**
- `spacy`: NLP工具包，无直接的标点恢复功能，需要大量定制开发
- `felflare/bert-restore-punctuation`: BERT模型，标点和大小写精度高，但模型重且在Yelp评论上训练
- `1-800-BAD-CODE/punctuation_fullstop_truecase_english`: Transformer模型，对复杂大写处理出色，但重量级

#### 2. 处理流程

```
输入文件 → 模型加载 → 标点恢复 → 后处理 → 输出文件
```

**详细步骤:**
1. **文件模式展开**: 解析通配符模式
2. **路径解析**: 使用默认路径处理逻辑
3. **模型初始化**: 加载 PunctuationModel
4. **文本处理**: 
   - UTF-8-SIG 编码读取（处理 BOM）
   - 应用 `restore_punctuation()` 方法
   - 后处理（句子分割、首字母大写、破折号转逗号）
5. **输出保存**: 写入 `data/output/` 目录

#### 3. 后处理规则

**自定义替换:**
- `' - '` → `', '` (破折号转逗号)
- `'- '` → `', '` (破折号转逗号)

**原因**: 模型有时生成破折号，但逗号更适合后续的进一步处理，比如 sentence_splitter。

## 设计决策

### 1. 智能路径处理

**决策**: 实现默认路径处理，支持 `data/input/` 和 `data/output/` 目录。

**优势:**
- 简化用户操作
- 自动创建必要目录
- 支持完整路径和相对路径

### 2. 通配符支持

**决策**: 支持通配符模式而非固定目录扫描。

**优势:**
- 更灵活的文件选择
- 支持单文件和批量处理
- 用户可控制处理范围

### 3. UTF-8-SIG 编码

**决策**: 使用 `utf-8-sig` 编码处理输入文件。

**原因:**
- 自动处理 BOM，避免编码错误
- 确保兼容各种文本编辑器创建的文件
- 防止编码相关的处理错误

### 4. 错误处理

**策略**: 单个文件失败不影响其他文件处理。

**实现:**
- 文件级别的异常捕获
- 详细的错误信息
- 空文件处理

## 文件结构

```
scripts/punctuation_adder/
├── main.py                    # 主程序
├── ARCHITECTURE.md           # 架构文档
├── README.md                 # 用户文档
└── ARCHITECTURE-Options.md   # 模型比较
```

## 依赖

### 核心依赖
- `deepmultilingualpunctuation`: 主要 ML 模型
- `os`, `glob`: 文件系统操作

### 系统要求
- Python 3.11+
- 足够内存加载模型
- 磁盘空间存储输出文件

## 限制

### 模型限制
1. **训练领域**: 基于政治演讲数据，对技术文本准确性可能较低
2. **功能重点**: 主要专注标点恢复，大小写纠正能力有限

### 处理限制
1. **文件格式**: 仅支持 `.txt` 文件
2. **编码**: 假设 UTF-8 兼容文本
3. **内存**: 大文件可能需要分块处理（未实现）

## 集成点

### 脚本管理器集成
- 注册为 `punctuation-adder`
- 依赖组: `punctuation-adder`
- 分类: `text_processing`

### 命令行接口
- 遵循项目标准的参数解析
- 支持 `--help` 帮助信息
- 适当的退出码