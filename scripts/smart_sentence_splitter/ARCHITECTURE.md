# SmartSentenceSplitter 架构说明

## 整体处理逻辑

### 命令行入口（`main`）
- 解析参数：必填 `input_file`，可选 `--output`
- 递归控制参数：
  - `--min-length`（默认 70）：最小递归长度阈值；低于该长度不再继续递归拆分
  - `--max-depth`（默认 5）：最大递归深度；达到该深度即停止递归
- 校验路径，创建 `SmartSentenceSplitter`，调用 `process_file`

### 文件处理（`process_file`）
- 读取输入文件的非空行（每行即一个句子）
- 调用 `process_sentences` 进行拆分
- 将结果写入输出文件（未指定则自动生成 `data/output/<stem>.smart_split.txt`）
- 输出统计信息

### 批量拆分（`process_sentences`）
- 遍历每个输入句子：
  - 调用 `split_sentence`，得到一到多行
- 拼接所有拆分结果返回

### 句子拆分（`split_sentence`）
- **保护措施**：
  - 递归停止条件：`depth >= max_depth` 或 `len(sentence) < min_recursive_length`
  - 若 `should_split_sentence` 为 False 或没有可用拆分点则不拆
- **选择"最佳拆分点"**：
  - 通过 `find_split_points` 找出候选点
  - 按优先级（高优先）与位置（更靠左）选取
- **非破坏式拆分**：
  - 若在逗号处分行，保证逗号及其后的一个空格留在上一行
  - 直接用切片生成 `part1 = sentence[:split_pos]`、`part2 = sentence[split_pos:]`，不改动任何标点或空白
- **递归处理**：对 `part1` 与 `part2` 各自独立评估；当某一部分 `len(part) >= min_recursive_length` 时，继续递归调用同一规则，否则直接收集该部分

### 拆分判定（`should_split_sentence`）
- 句长需 ≥ 60
- 不再使用特例化“问题模式”，统一依赖长度阈值与优先级策略；仅要求 `find_split_points` 返回至少一个候选点

### 查找拆分点（`find_split_points`）
- 产出候选点三元组 `(position, priority, reason)`
- **候选来源**：
  - **标点**：`;`（最高）、`:`、`,`（并排除数字逗号与简单并列中的逗号）
  - **"逗号+连接词/模式"**（如 `, then`、`, so`、`, which` 等）提升优先级
  - **句中连接词**（and/or/but/because/while/which/that/...）：
    - 必须是完整词形
    - 需保证连接词前后有足够内容（句首只要求右侧足够）
    - 若处于从句内部则跳过
- 返回按位置升序排列的候选点列表

### 上下文辅助函数
- **`is_number_context`**：识别数字/金额中的逗号（如 1,000、3.14、$1,000），避免在此拆分
- **`is_simple_enumeration`**：识别逗号附近的简单枚举，避免在此拆分（如多个短词并列）
- **`_is_in_subordinate_clause`**：避免在由 which/that/who/when/where 等引导的从句内部落点拆分

## 关键行为/不变式

### 非破坏式输出
- 仅插入换行，不增删/重写任何字符
- 特别是逗号换行会把逗号与一个空格留在上一行，避免下一行以标点开头

### 优先级驱动
- 优先使用语义更强的拆分线索：
  - 分号 > 冒号 > 逗号+连接词/模式 > 普通逗号 > 独立连接词

### 安全防护
- 长度阈值与问题模式过滤防止过拆与尴尬碎片

### 递归细化
- 对较长片段继续用同样规则细分，得到更可读、平衡的行

## 设计原则

1. **保持原文完整性**：只做换行处理，不修改任何文字内容
2. **智能拆分**：基于语法规则和语义线索进行拆分
3. **避免误拆**：通过多种检查机制避免破坏句子结构
4. **递归优化**：对复杂长句进行多轮拆分，确保每行都合理
5. **可配置性**：通过参数调整拆分策略和阈值

## 技术特点

- **基于规则**：无需LLM，完全基于语法规则和启发式方法
- **高效处理**：支持批量处理大量文本
- **可扩展性**：易于添加新的拆分规则和模式
- **鲁棒性**：包含多种边界情况处理机制
